<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>iLab Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙØ­ÙˆØµØ§Øª ÙˆØ­Ø¬Ø² Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
--bg:#f7fbff; --card:#ffffff; --accent:#0f6fa6; --accent2:#0fa37a; --muted:#6b7280;
}
body{font-family:'Cairo',sans-serif;background:linear-gradient(180deg,var(--bg),#eef6f8);margin:0;padding:22px;direction:rtl;color:#043047;}
.wrap{max-width:980px;margin:0 auto}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:12px}
h1{margin:0;font-size:20px;color:var(--accent)}
.sub{color:var(--muted);font-size:13px}
.layout{display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start}
.card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 6px 30px rgba(2,6,23,0.06)}
.title{font-weight:700;color:#08304a;margin-bottom:10px}
.tests{max-height:200px;overflow:auto;padding:6px;border-radius:10px;border:1px dashed #e6f0f7}
.test-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;margin:6px 0}
input[type="search"], input[type="text"], textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e8f1f7}
textarea{min-height:80px;resize:vertical}
.btn{background:var(--accent);color:#fff;padding:12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;margin-top:8px}
.total{font-size:20px;font-weight:800;color:var(--accent2);margin-top:12px}
.hint{font-size:13px;color:var(--muted);margin-top:8px}
.coupon-box{display:flex;gap:8px;align-items:center}
.small{font-size:13px;color:var(--muted)}
@media(max-width:880px){.layout{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div>
    <h1>Ø­Ø§Ø³Ø¨Ø© ÙˆØ§Ø³ØªÙØ³Ø§Ø± Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ÙØ­ÙˆØµØ§Øª â€” iLab</h1>
    <div class="sub">Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„ÙØ­ÙˆØµØ§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§ â€” Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¨ÙˆÙ† Ø¥Ù† ÙˆÙØ¬Ø¯</div>
  </div>
</header>

<div class="layout">
  <!-- Ø§Ù„ÙŠØ³Ø§Ø±: Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª -->
  <div class="card">
    <div class="title">âœ… Ø§Ø®ØªØ± Ø§Ù„ÙØ­ÙˆØµØ§Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
    <input id="searchTests" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙØ­Øµ Ù…Ø«Ù„Ø§Ù‹: ÙÙŠØªØ§Ù…ÙŠÙ† D, CBC" oninput="filterTests()">
    <div id="testsList" class="tests">ØªØ­Ù…ÙŠÙ„â€¦</div>

    <div class="title">ğŸ“ Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ­ÙˆØµØ§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§</div>
    <textarea id="manual" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„ ÙØ­Øµ Ø¨Ø³Ø·Ø± ÙˆØ§Ø­Ø¯"></textarea>

    <div class="title">ğŸŸï¸ ÙƒÙˆØ¨ÙˆÙ† Ø§Ù„Ø®ØµÙ…</div>
    <div class="coupon-box">
      <input id="coupon" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ø¥Ù† ÙˆÙØ¬Ø¯">
      <button class="btn" onclick="calculate()">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø±</button>
    </div>

    <div class="title">ğŸ“… Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯</div>
    <input id="name" type="text" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
    <input id="phone" type="text" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
    <button class="btn" onclick="bookAppointment()">Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†</button>
    <div id="bookResult" class="small"></div>

    <div class="hint">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ùˆ/Ø£Ùˆ ÙƒØªØ§Ø¨Ø© ÙØ­ÙˆØµØ§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ â€” Ø§Ù„ØµÙØ­Ø© ØªØ¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ø±ÙÙŠØ©.</div>
  </div>

  <!-- Ø§Ù„ÙŠÙ…ÙŠÙ†: Ø§Ù„Ù…Ù„Ø®Øµ -->
  <div class="card">
    <div class="title">Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</div>
    <div class="small">Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</div>
    <div id="selectedList" style="margin-top:10px;min-height:120px"></div>
    <div class="total" id="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 Ø¯.Ø§</div>
    <div id="couponNote" class="small" style="margin-top:8px"></div>
  </div>
</div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbw-LYZhxTiVzFU9F_OWZgWZGXvmFsfmp5UbcFP0x27OYHis6EYSWBgdse34i4Wkj9Wm/exec"; // Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Web App
let tests=[], coupons=[];

async function loadData(){
  try{
    tests = await fetch(API+'?action=getTests').then(r=>r.json());
    coupons = await fetch(API+'?action=getCoupons').then(r=>r.json());
    renderTestsList();
  }catch(e){
    document.getElementById('testsList').innerText='ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ­ÙˆØµØ§Øª';
    console.error(e);
  }
}

function renderTestsList(){
  const container = document.getElementById('testsList');
  container.innerHTML='';
  if(!tests.length){ container.innerHTML='<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ­ÙˆØµØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>'; return; }
  tests.forEach((row, idx)=>{
    const div = document.createElement('div');
    div.className='test-row';
    div.innerHTML=`<label style="display:flex;align-items:center;gap:12px;width:100%">
      <input type="checkbox" data-i="${idx}" onchange="updateSelected()">
      <div style="flex:1"><div style="font-weight:600">${escapeHtml(row[0])}</div><div class="small">${escapeHtml(row[1])} Ø¯.Ø§</div></div>
    </label>`;
    container.appendChild(div);
  });
}

function escapeHtml(s){return (s+'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}

function updateSelected(){
  const sel = Array.from(document.querySelectorAll('#testsList input[type=checkbox]:checked')).map(ch => tests[parseInt(ch.dataset.i)]);
  const out = document.getElementById('selectedList');
  out.innerHTML='';
  if(!sel.length){ out.innerHTML='<div class="small">Ù„Ù… ØªØ®ØªÙØ± Ø£ÙŠ ÙØ­Øµ Ø¨Ø¹Ø¯</div>'; return; }
  sel.forEach(s=>{
    const row = document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px 0';
    row.innerHTML=`<div>${escapeHtml(s[0])}</div><div class="small">${escapeHtml(s[1])} Ø¯.Ø§</div>`;
    out.appendChild(row);
  });
}

function filterTests(){
  const q=document.getElementById('searchTests').value.trim().toLowerCase();
  Array.from(document.getElementById('testsList').children).forEach((el,idx)=>{
    const name=(tests[idx] && tests[idx][0] || '').toLowerCase();
    el.style.display = (!q || name.indexOf(q)!==-1)? 'block':'none';
  });
}

function calculate(){
  let total=0;
  const checked = Array.from(document.querySelectorAll('#testsList input[type=checkbox]:checked'));
  checked.forEach(ch=>{
    const row = tests[parseInt(ch.dataset.i)];
    if(row) total+=parseFloat(row[1]||0);
  });

  const manual=document.getElementById('manual').value.trim();
  const notFound=[];
  if(manual){
    manual.split('\n').map(l=>l.trim()).filter(Boolean).forEach(line=>{
      const found=tests.find(r=>r[0].toLowerCase()===line.toLowerCase());
      if(found) total+=parseFloat(found[1]||0);
      else notFound.push(line);
    });
  }

  const code=document.getElementById('coupon').value.trim().toUpperCase();
  let note='';
  if(code){
    const c = coupons.find(c=>c[0].toUpperCase()===code);
    if(c){
      const type=c[1], val=parseFloat(c[2]);
      if(type==='percent') total-=(total*val/100);
      else total-=val;
      note=`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ${code} (${type==='percent'?val+'%':'Ù‚ÙŠÙ…Ø© '+val+' Ø¯.Ø§'})`;
    }else note=`Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ${code} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`;
  }

  if(total<0) total=0;
  document.getElementById('total').innerText='Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: '+parseFloat(total.toFixed(2))+' Ø¯.Ø§';
  document.getElementById('couponNote').innerText=note + (notFound.length? ' â€” Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰: '+notFound.join(', '):'');
  updateSelected();
}

async function bookAppointment(){
  calculate();
  const name=document.getElementById('name').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const testsList=Array.from(document.querySelectorAll('#testsList input[type=checkbox]:checked')).map(ch=>tests[parseInt(ch.dataset.i)][0]);
  const manual=document.getElementById('manual').value.trim().split('\n').map(l=>l.trim()).filter(Boolean);
  testsList.push(...manual);
  const total=parseFloat(document.getElementById('total').innerText.replace('Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ','').replace(' Ø¯.Ø§',''));
  if(!name||!phone||!testsList.length){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…ØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ­ÙˆØµØ§Øª'); return; }

  try{
    const resp=await fetch(`${API}?action=addAppointment&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}&tests=${encodeURIComponent(testsList.join(','))}&total=${total}`);
    const data=await resp.json();
    document.getElementById('bookResult').innerText=data.status||'ØªÙ… Ø§Ù„Ø­Ø¬Ø²';
    document.getElementById('name').value=''; document.getElementById('phone').value=''; document.getElementById('manual').value='';
    Array.from(document.querySelectorAll('#testsList input[type=checkbox]')).forEach(cb=>cb.checked=false);
    calculate();
  }catch(e){console.error(e); alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø¬Ø²');}
}

// init
loadData();
</script>
</body>
</html>
