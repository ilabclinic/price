<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>iLab حاسبة الفحوصات وحجز المواعيد</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
--bg:#f7fbff; --card:#ffffff; --accent:#0f6fa6; --accent2:#0fa37a; --muted:#6b7280;
}
body{font-family:'Cairo',sans-serif;background:linear-gradient(180deg,var(--bg),#eef6f8);margin:0;padding:22px;direction:rtl;color:#043047;}
.wrap{max-width:980px;margin:0 auto}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:12px}
h1{margin:0;font-size:20px;color:var(--accent)}
.sub{color:var(--muted);font-size:13px}
.layout{display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start}
.card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 6px 30px rgba(2,6,23,0.06)}
.title{font-weight:700;color:#08304a;margin-bottom:10px}
.tests{max-height:200px;overflow:auto;padding:6px;border-radius:10px;border:1px dashed #e6f0f7}
.test-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;margin:6px 0}
input[type="search"], input[type="text"], textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e8f1f7}
textarea{min-height:80px;resize:vertical}
.btn{background:var(--accent);color:#fff;padding:12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;margin-top:8px}
.total{font-size:20px;font-weight:800;color:var(--accent2);margin-top:12px}
.hint{font-size:13px;color:var(--muted);margin-top:8px}
.coupon-box{display:flex;gap:8px;align-items:center}
.small{font-size:13px;color:var(--muted)}
@media(max-width:880px){.layout{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div>
    <h1>حاسبة واستفسار أسعار الفحوصات — iLab</h1>
    <div class="sub">اختر من القائمة أو اكتب الفحوصات يدويًا — أدخل كوبون إن وُجد</div>
  </div>
</header>

<div class="layout">
  <!-- اليسار: الاختيارات -->
  <div class="card">
    <div class="title">✅ اختر الفحوصات من القائمة</div>
    <input id="searchTests" type="search" placeholder="ابحث عن فحص مثلاً: فيتامين D, CBC" oninput="filterTests()">
    <div id="testsList" class="tests">تحميل…</div>

    <div class="title">📝 أو أدخل أسماء الفحوصات يدويًا</div>
    <textarea id="manual" placeholder="أدخل كل فحص بسطر واحد"></textarea>

    <div class="title">🎟️ كوبون الخصم</div>
    <div class="coupon-box">
      <input id="coupon" type="text" placeholder="أدخل الكوبون إن وُجد">
      <button class="btn" onclick="calculate()">احسب السعر</button>
    </div>

    <div class="title">📅 حجز موعد</div>
    <input id="name" type="text" placeholder="الاسم الكامل">
    <input id="phone" type="text" placeholder="رقم الهاتف">
    <button class="btn" onclick="bookAppointment()">احجز الآن</button>
    <div id="bookResult" class="small"></div>

    <div class="hint">يمكنك اختيار من القائمة و/أو كتابة فحوصات يدوياً — الصفحة تبحث بالمطابقة الحرفية.</div>
  </div>

  <!-- اليمين: الملخص -->
  <div class="card">
    <div class="title">ملخص الطلب</div>
    <div class="small">الفحوصات المختارة</div>
    <div id="selectedList" style="margin-top:10px;min-height:120px"></div>
    <div class="total" id="total">الإجمالي: 0 د.ا</div>
    <div id="couponNote" class="small" style="margin-top:8px"></div>
  </div>
</div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbw-LYZhxTiVzFU9F_OWZgWZGXvmFsfmp5UbcFP0x27OYHis6EYSWBgdse34i4Wkj9Wm/exec"; // ضع هنا رابط Web App
let tests=[], coupons=[];

async function loadData(){
  try{
    tests = await fetch(API+'?action=getTests').then(r=>r.json());
    coupons = await fetch(API+'?action=getCoupons').then(r=>r.json());
    renderTestsList();
  }catch(e){
    document.getElementById('testsList').innerText='تعذر تحميل الفحوصات';
    console.error(e);
  }
}

function renderTestsList(){
  const container = document.getElementById('testsList');
  container.innerHTML='';
  if(!tests.length){ container.innerHTML='<div class="small">لا توجد فحوصات حالياً</div>'; return; }
  tests.forEach((row, idx)=>{
    const div = document.createElement('div');
    div.className='test-row';
    div.innerHTML=`<label style="display:flex;align-items:center;gap:12px;width:100%">
      <input type="checkbox" data-i="${idx}" onchange="updateSelected()">
      <div style="flex:1"><div style="font-weight:600">${escapeHtml(row[0])}</div><div class="small">${escapeHtml(row[1])} د.ا</div></div>
    </label>`;
    container.appendChild(div);
  });
}

function escapeHtml(s){return (s+'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}

function updateSelected(){
  const sel = Array.from(document.querySelectorAll('#testsList input[type=checkbox]:checked')).map(ch => tests[parseInt(ch.dataset.i)]);
  const out = document.getElementById('selectedList');
  out.innerHTML='';
  if(!sel.length){ out.innerHTML='<div class="small">لم تختَر أي فحص بعد</div>'; return; }
  sel.forEach(s=>{
    const row = document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px 0';
    row.innerHTML=`<div>${escapeHtml(s[0])}</div><div class="small">${escapeHtml(s[1])} د.ا</div>`;
    out.appendChild(row);
  });
}

function filterTests(){
  const q=document.getElementById('searchTests').value.trim().toLowerCase();
  Array.from(document.getElementById('testsList').children).forEach((el,idx)=>{
    const name=(tests[idx] && tests[idx][0] || '').toLowerCase();
    el.style.display = (!q || name.indexOf(q)!==-1)? 'block':'none';
  });
}

function calculate(){
  let total=0;
  const checked = Array.from(document.querySelectorAll('#testsList input[type=checkbox]:checked'));
  checked.forEach(ch=>{
    const row = tests[parseInt(ch.dataset.i)];
    if(row) total+=parseFloat(row[1]||0);
  });

  const manual=document.getElementById('manual').value.trim();
  const notFound=[];
  if(manual){
    manual.split('\n').map(l=>l.trim()).filter(Boolean).forEach(line=>{
      const found=tests.find(r=>r[0].toLowerCase()===line.toLowerCase());
      if(found) total+=parseFloat(found[1]||0);
      else notFound.push(line);
    });
  }

  const code=document.getElementById('coupon').value.trim().toUpperCase();
  let note='';
  if(code){
    const c = coupons.find(c=>c[0].toUpperCase()===code);
    if(c){
      const type=c[1], val=parseFloat(c[2]);
      if(type==='percent') total-=(total*val/100);
      else total-=val;
      note=`تم تطبيق الكوبون ${code} (${type==='percent'?val+'%':'قيمة '+val+' د.ا'})`;
    }else note=`الكوبون ${code} غير موجود`;
  }

  if(total<0) total=0;
  document.getElementById('total').innerText='الإجمالي: '+parseFloat(total.toFixed(2))+' د.ا';
  document.getElementById('couponNote').innerText=note + (notFound.length? ' — لم يتم العثور على: '+notFound.join(', '):'');
  updateSelected();
}

async function bookAppointment(){
  calculate();
  const name=document.getElementById('name').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const testsList=Array.from(document.querySelectorAll('#testsList input[type=checkbox]:checked')).map(ch=>tests[parseInt(ch.dataset.i)][0]);
  const manual=document.getElementById('manual').value.trim().split('\n').map(l=>l.trim()).filter(Boolean);
  testsList.push(...manual);
  const total=parseFloat(document.getElementById('total').innerText.replace('الإجمالي: ','').replace(' د.ا',''));
  if(!name||!phone||!testsList.length){ alert('الرجاء إدخال الاسم، رقم الهاتف واختيار الفحوصات'); return; }

  try{
    const resp=await fetch(`${API}?action=addAppointment&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}&tests=${encodeURIComponent(testsList.join(','))}&total=${total}`);
    const data=await resp.json();
    document.getElementById('bookResult').innerText=data.status||'تم الحجز';
    document.getElementById('name').value=''; document.getElementById('phone').value=''; document.getElementById('manual').value='';
    Array.from(document.querySelectorAll('#testsList input[type=checkbox]')).forEach(cb=>cb.checked=false);
    calculate();
  }catch(e){console.error(e); alert('تعذر الحجز');}
}

// init
loadData();
</script>
</body>
</html>
